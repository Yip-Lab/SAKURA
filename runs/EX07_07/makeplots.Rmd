---
title: "Make run summary plots"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(dplyr)
require(magrittr)
require(reshape2)
require(Matrix)
require(ggExtra)
options(stringsAsFactors = FALSE)
getwd()
```

# Configuration

```{r paths}
emb_path <- './runs/EX07_07/logs'
pheno_df_path <- './dataset/10X_Purified_PBMC/pooled_pheno.csv'
expr_mat_path <- './dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered.mtx'
gene_name_path <- './dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered_gene_names.csv'
cell_name_path <- './dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered_cell_names.csv'
```

# Import Labels

```{r import labels}
pheno_df <- read.csv(pheno_df_path) %>%
  rename('cell' = 'X')
expr_mat <- readMM(expr_mat_path)
gene_names <- read.csv(gene_name_path)[, 2]
cell_names <- read.csv(cell_name_path)[, 2]
rownames(expr_mat) <- gene_names
colnames(expr_mat) <- cell_names
```

# Make Embedding Plots

```{r global configs}
total_epochs <- 100
```

## Main latent plots (main.1 and main.2)


```{r signature latent plots}
try({
      keys_to_plot <- c("overall_train_all_latent", "overall_test_all_latent")
      output_width <- 15
      output_height <- 15
      for (i in c(seq(1, total_epochs, 9), total_epochs)) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
            left_join(y = pheno_df %>% select(cell, data_key), by = 'cell')

          plt <- ggplot(cur_emb) +
            geom_point(aes(x = main.1, y = main.2, color = data_key)) +
            theme_classic() +
            theme(legend.position = 'bottom')
          plt <- ggMarginal(plt, groupColour = TRUE, groupFill = TRUE)
          plt_path <- './runs/EX07_07/plots/main_lat'
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_main.jpg')
          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)
        }
      }
    })
```

## Phenotype latents

```{r signature distrib}
try({
      keys_to_plot <- c("overall_train_all_latent", "overall_test_all_latent")
      output_width <- 10
      output_height <- 10
      for (i in c(seq(1, total_epochs, 9), total_epochs)) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
            left_join(y = pheno_df %>% select(cell, data_key), by = 'cell')
          cur_emb2 <- cur_emb %>% select(-data_key, -data_key)
          plt <- ggplot() +
            geom_density(data = cur_emb, aes(x = data_key.1, colour = data_key)) +
            geom_density(data = cur_emb2, aes(x = data_key.1), colour = "grey") +
            # facet_wrap(~data_key) +
            theme_classic() +
            theme(legend.position = 'bottom')

          plt_path <- './runs/EX07_07/plots/pheno_distrib'
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_data_key.jpg')
          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)
        }
      }
    })
```

## 3-D Plots

```{r}
require(plotly)
require(htmlwidgets)
try({
      keys_to_plot <- c("overall_train_all_latent", "overall_test_all_latent")
      for (i in c(seq(1, total_epochs, 9), total_epochs)) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
            left_join(y = pheno_df %>% select(cell, data_key), by = 'cell')
          plt <- plot_ly(cur_emb, x = ~main.1, y = ~main.2, z = ~data_key.1, color = ~data_key)
          plt_path <- paste0(getwd(), '/runs/EX07_07/plots/3d_plt/', i, '_main.1_main.2_data_key_', cur_key)
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/plt.html')
          saveWidget(plt, file = plt_filename)
        }
      }
    })

```

# Notes

## Observations

Seems our proposal in EX07_02 is working. By lowering the weight of extra latent loss, the mixing of different classes are alleviated, while perserving some useful patterns, e.g. CD4+ is spanning on other types of detailed CD4+ cells. Cells are also mixed better in the main latent space, from the marginal distributions.

Next we will test what will happen if we give one more dimension to extra latent of data_key.

## Console outputs (initial part)

```
/Users/hahaschool/Desktop/Research/SAKRA/venv/bin/python "/Volumes/Macintosh HD/Applications/PyCharm.app/Contents/plugins/python/helpers/pydev/pydevconsole.py" --mode=client --port=58197
import sys; print('Python %s on %s' % (sys.version, sys.platform))
sys.path.extend(['/Users/hahaschool/Desktop/Research/SAKRA'])
PyDev console: starting.
Python 3.7.8 (default, Jul  4 2020, 10:17:17)
[Clang 11.0.3 (clang-1103.0.32.62)] on darwin
>>> runfile('/Users/hahaschool/Desktop/Research/SAKRA/SAKRA.py', args=['--config', './runs/EX07_07/config.json', '--verbose', 'True'], wdir='/Users/hahaschool/Desktop/Research/SAKRA')
SCARE/SAKRA Prototype
Loading dataset...
Reproducibe seed: 114514
Loading expression matrix from mtx (MM) file.
==========================
rna_count dataset (sparse MM version):
Imported gene expression matrix from: ./dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered.mtx
Imported gene names from: ./dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered_gene_names.csv
Imported cell names from: ./dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered_cell_names.csv
(19705, 94655)
cell     CD14+_Monocytes-AAACATACCACTAG-1  ...  CD14+_Monocytes-AAACATTGACGGTT-1
gene                                       ...
FAM138A                          0.000000  ...                          0.000000
OR4F5                            0.000000  ...                          0.000000
OR4F29                           0.000000  ...                          0.000000
OR4F16                           0.000000  ...                          0.000000
FAM87B                           0.000000  ...                          0.000000
                                   ...  ...                               ...
MT-ND4L                          0.000000  ...                          0.000000
MT-ND4                           2.807975  ...                          0.000000
MT-ND5                           0.000000  ...                          0.000000
MT-ND6                           0.000000  ...                          0.000000
MT-CYB                           0.000000  ...                          2.709732
[19705 rows x 3 columns]
No external gene expression set provided, using dummy.
Gene expression set metadata:
{'all': {'gene_list': '*', 'pre_procedure': [], 'post_procedure': [{'type': 'ToTensor'}]}}
Phenotype data from CSV from: ./dataset/10X_Purified_PBMC/shuffled_pooled_pheno.csv
(94655, 1)
                                                                     data_key
X
CD14+_Monocytes-AAACATACCACTAG-1                                CD19+_B_Cells
CD14+_Monocytes-AAACATACGTTCAG-1         CD8+_CD45RA+_Naive_Cytotoxic_T_Cells
CD14+_Monocytes-AAACATTGACGGTT-1                                  CD34+_Cells
CD14+_Monocytes-AAACATTGCTTCGC-1                  CD4+_CD45RO+_Memory_T_Cells
CD14+_Monocytes-AAACATTGGGCAAG-1                              CD14+_Monocytes
                                                                       ...
CD8+_Cytotoxic_T_cells-TTTGCATGAACGGG-1           CD4+_CD45RO+_Memory_T_Cells
CD8+_Cytotoxic_T_cells-TTTGCATGAAGATG-1         CD4+_CD25+_Regulatory_T_Cells
CD8+_Cytotoxic_T_cells-TTTGCATGAGCGTT-1           CD4+_CD45RO+_Memory_T_Cells
CD8+_Cytotoxic_T_cells-TTTGCATGCAAGCT-1                CD8+_Cytotoxic_T_cells
CD8+_Cytotoxic_T_cells-TTTGCATGCCGCTT-1           CD4+_CD45RO+_Memory_T_Cells
[94655 rows x 1 columns]
Reading phenotype metadata json from: ./runs/EX07_07/pheno_meta.json
==========================
Configuration integrity pre-check ok: True
==========================
Splits:
{'all': array([ True,  True,  True, ...,  True,  True,  True]), 'overall_train': array([ True,  True, False, ...,  True,  True,  True]), 'overall_test': array([False, False,  True, ..., False, False, False]), 'pheno_data_key_train': array([False, False, False, ..., False, False, False]), 'pheno_data_key_test': array([ True,  True, False, ...,  True,  True,  True])}
Model built:
ModuleDict(
  (decoder): FCDecoder(
    (model_list): ModuleList(
      (0): Linear(in_features=3, out_features=50, bias=True)
      (1): CELU(alpha=1.0)
      (2): Linear(in_features=50, out_features=50, bias=True)
      (3): CELU(alpha=1.0)
      (4): Linear(in_features=50, out_features=19705, bias=True)
    )
  )
  (main_latent_compressor): FCCompressor(
    (model_list): ModuleList(
      (0): Linear(in_features=50, out_features=2, bias=True)
    )
    (model): Sequential(
      (0): ModuleList(
        (0): Linear(in_features=50, out_features=2, bias=True)
      )
    )
  )
  (pheno_latent_compressors): ModuleDict(
    (data_key): FCCompressor(
      (model_list): ModuleList(
        (0): Linear(in_features=50, out_features=1, bias=True)
      )
      (model): Sequential(
        (0): ModuleList(
          (0): Linear(in_features=50, out_features=1, bias=True)
        )
      )
    )
  )
  (pheno_models): ModuleDict(
    (data_key): LinClassifier(
      (model_list): ModuleList(
        (0): Linear(in_features=1, out_features=10, bias=True)
        (1): LogSoftmax()
      )
      (model): Sequential(
        (0): ModuleList(
          (0): Linear(in_features=1, out_features=10, bias=True)
          (1): LogSoftmax()
        )
      )
    )
  )
  (pre_encoder): FCPreEncoder(
    (model_list): ModuleList(
      (0): Linear(in_features=19705, out_features=50, bias=True)
      (1): CELU(alpha=1.0)
      (2): Linear(in_features=50, out_features=50, bias=True)
      (3): CELU(alpha=1.0)
    )
  )
  (signature_latent_compressors): ModuleDict()
  (signature_regressors): ModuleDict()
)
===========================
Extractor controller
{'data_key': {'pheno_df_key': 'data_key', 'type': 'categorical', 'order': ['CD14+_Monocytes', 'CD19+_B_Cells', 'CD34+_Cells', 'CD4+_CD25+_Regulatory_T_Cells', 'CD4+_CD45RA+_CD25-_Naive_T_cells', 'CD4+_CD45RO+_Memory_T_Cells', 'CD4+_Helper_T_Cells', 'CD56+_Natural_Killer_Cells', 'CD8+_CD45RA+_Naive_Cytotoxic_T_Cells', 'CD8+_Cytotoxic_T_cells'], 'pheno_lat_dim': 1, 'pheno_out_dim': 10, 'model': {'type': 'LinClassifier'}, 'loss': {'NLL': {'type': 'NLL', 'init_weight': 1.0, 'progressive_start_epoch': 10, 'progressive_const': 1.0}}, 'pre_procedure': [], 'post_procedure': [{'type': 'ToOrdinal'}, {'type': 'ToTensor'}], 'init_weight': 1.0, 'progressive_start_epoch': 10, 'progressive_const': 1.0, 'split': {'type': 'auto', 'base': 'overall_train', 'train_dec': 1, 'seed': 810893}, 'regularization': {'shape_uniform_unsupervised': {'type': 'SW2_uniform', 'SW2_num_projections': 50, 'uniform_low': -10, 'uniform_high': 10, 'progressive_const': 1.05, 'progressive_start_epoch': 1, 'init_weight': 0.1, 'max_weight': 1.0}}}}
{}
{'encoder_neurons': 50, 'decoder_neurons': 50, 'latent_dim': 2, 'loss': {'L2': {'type': 'MSE', 'init_weight': 1.0, 'progressive_const': 1.0, 'progressive_start_epoch': 100}, 'L1': {'type': 'L1', 'init_weight': 1.0, 'progressive_const': 1.0, 'progressive_start_epoch': 100}}, 'regularization': {'uniform_shape_unsupervised': {'type': 'SW2_uniform', 'init_weight': 1, 'progressive_const': 1.1, 'progressive_start_epoch': 1, 'max_weight': 10.0, 'SW2_num_projections': 50, 'uniform_low': -10, 'uniform_high': 10}}}
RMSprop (
Parameter Group 0
    alpha: 0.9
    centered: False
    eps: 1e-08
    lr: 0.001
    momentum: 0
    weight_decay: 0
)
      main_loss_L2    main_loss_L1    main_regularization_uniform_shape_unsupervised    pheno_data_key_loss_NLL    pheno_data_key_regularization_shape_uniform_unsupervised
--  --------------  --------------  ------------------------------------------------  -------------------------  ----------------------------------------------------------
 0               1               1                                           1                                1                                                    0.1
 1               1               1                                           1.1                              1                                                    0.105
 2               1               1                                           1.21                             1                                                    0.11025
 3               1               1                                           1.331                            1                                                    0.115763
 4               1               1                                           1.4641                           1                                                    0.121551
 5               1               1                                           1.61051                          1                                                    0.127628
 6               1               1                                           1.77156                          1                                                    0.13401
 7               1               1                                           1.94872                          1                                                    0.14071
 8               1               1                                           2.14359                          1                                                    0.147746
 9               1               1                                           2.35795                          1                                                    0.155133
10               1               1                                           2.59374                          1                                                    0.162889
11               1               1                                           2.85312                          1                                                    0.171034
12               1               1                                           3.13843                          1                                                    0.179586
13               1               1                                           3.45227                          1                                                    0.188565
14               1               1                                           3.7975                           1                                                    0.197993
15               1               1                                           4.17725                          1                                                    0.207893
16               1               1                                           4.59497                          1                                                    0.218287
17               1               1                                           5.05447                          1                                                    0.229202
18               1               1                                           5.55992                          1                                                    0.240662
19               1               1                                           6.11591                          1                                                    0.252695
20               1               1                                           6.7275                           1                                                    0.26533
21               1               1                                           7.40025                          1                                                    0.278596
22               1               1                                           8.14027                          1                                                    0.292526
23               1               1                                           8.9543                           1                                                    0.307152
24               1               1                                           9.84973                          1                                                    0.32251
25               1               1                                          10                                1                                                    0.338635
26               1               1                                          10                                1                                                    0.355567
27               1               1                                          10                                1                                                    0.373346
28               1               1                                          10                                1                                                    0.392013
29               1               1                                          10                                1                                                    0.411614
30               1               1                                          10                                1                                                    0.432194
31               1               1                                          10                                1                                                    0.453804
32               1               1                                          10                                1                                                    0.476494
33               1               1                                          10                                1                                                    0.500319
34               1               1                                          10                                1                                                    0.525335
35               1               1                                          10                                1                                                    0.551602
36               1               1                                          10                                1                                                    0.579182
37               1               1                                          10                                1                                                    0.608141
38               1               1                                          10                                1                                                    0.638548
39               1               1                                          10                                1                                                    0.670475
40               1               1                                          10                                1                                                    0.703999
41               1               1                                          10                                1                                                    0.739199
42               1               1                                          10                                1                                                    0.776159
43               1               1                                          10                                1                                                    0.814967
44               1               1                                          10                                1                                                    0.855715
45               1               1                                          10                                1                                                    0.898501
46               1               1                                          10                                1                                                    0.943426
47               1               1                                          10                                1                                                    0.990597
48               1               1                                          10                                1                                                    1
49               1               1                                          10                                1                                                    1
50               1               1                                          10                                1                                                    1
51               1               1                                          10                                1                                                    1
52               1               1                                          10                                1                                                    1
53               1               1                                          10                                1                                                    1
54               1               1                                          10                                1                                                    1
55               1               1                                          10                                1                                                    1
56               1               1                                          10                                1                                                    1
57               1               1                                          10                                1                                                    1
58               1               1                                          10                                1                                                    1
59               1               1                                          10                                1                                                    1
60               1               1                                          10                                1                                                    1
61               1               1                                          10                                1                                                    1
62               1               1                                          10                                1                                                    1
63               1               1                                          10                                1                                                    1
64               1               1                                          10                                1                                                    1
65               1               1                                          10                                1                                                    1
66               1               1                                          10                                1                                                    1
67               1               1                                          10                                1                                                    1
68               1               1                                          10                                1                                                    1
69               1               1                                          10                                1                                                    1
70               1               1                                          10                                1                                                    1
71               1               1                                          10                                1                                                    1
72               1               1                                          10                                1                                                    1
73               1               1                                          10                                1                                                    1
74               1               1                                          10                                1                                                    1
75               1               1                                          10                                1                                                    1
76               1               1                                          10                                1                                                    1
77               1               1                                          10                                1                                                    1
78               1               1                                          10                                1                                                    1
79               1               1                                          10                                1                                                    1
80               1               1                                          10                                1                                                    1
81               1               1                                          10                                1                                                    1
82               1               1                                          10                                1                                                    1
83               1               1                                          10                                1                                                    1
84               1               1                                          10                                1                                                    1
85               1               1                                          10                                1                                                    1
86               1               1                                          10                                1                                                    1
87               1               1                                          10                                1                                                    1
88               1               1                                          10                                1                                                    1
89               1               1                                          10                                1                                                    1
90               1               1                                          10                                1                                                    1
91               1               1                                          10                                1                                                    1
92               1               1                                          10                                1                                                    1
93               1               1                                          10                                1                                                    1
94               1               1                                          10                                1                                                    1
95               1               1                                          10                                1                                                    1
96               1               1                                          10                                1                                                    1
97               1               1                                          10                                1                                                    1
98               1               1                                          10                                1                                                    1
99               1               1                                          10                                1                                                    1
===========================


```